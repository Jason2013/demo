
-Global VerificationMode=1 -Tests PrimSetup -PrimSetup VertexCount=100000
-Global VerificationMode=2 -Tests PrimSetup -PrimSetup VertexCount=100000

-Global VerificationMode=1 Api=D3D11,D3D12 RefApi=D3D12,D3D11 -Tests PrimSetup -PrimSetup VertexCount=100000 TestCaseId=0-10
-Global VerificationMode=2 -Tests PrimSetup -PrimSetup VertexCount=100000

--------------------------------------------------------------------------------

VerificationInfo
{
    VerificationImageView
    {
        m_pImageView;
        m_levelOffset;
        m_sliceOffset;
        Region
        {
            x, y;
            width, height;
        }
        m_regions;
    }
    VerificationBuffer
    {
        m_pBuffer;
        Range
        {
            offset;
            size;
        }
        m_ranges;
    }
    m_imageViews;
    m_buffers;
    m_regionIdx;
}

有待改进：
==========


--------------------------------------------------------------------------------

d:\work\dev\dk_upgrade_dev\framework\src\GllBaseTest.cpp:556
void GllBaseTest::RegisterFramebuffer(gll::IFramebuffer* pFramebuffer, AttachmentIndex attachmentIndex, RegisterPurpose purpose, uint32_t levelOffset, uint32_t sliceOffset, uint32_t numVerificationRegions, mb::Region* pVerificationRegion)

其中的 if 语句与其 `GllBaseTest::RegisterImageView` 中的 if 语句重复，可以删除。

--------------------------------------------------------------------------------

d:\work\dev\dk_upgrade_dev\framework\src\BaseTest.cpp:778

        for (decltype(nRefApiSize) i = 0; i < nRefApiSize; i++)
        {
            ApiList::iterator iterFindInApiList = std::find(m_apiList.begin(), m_apiList.end(), m_refApiList[i]);
            ApiList::iterator iterFindInRefApiList = std::find(m_wholeApiList.begin(), m_wholeApiList.end(), m_refApiList[i]);
            if (iterFindInApiList == m_apiList.end() && iterFindInRefApiList == m_wholeApiList.end())
            {
                m_wholeApiList.push_back(m_refApiList[i]);
            }
        }

其目的是将 m_apiList 和 m_refApiList 合并到 m_wholeApiList 中。其中对 m_apiList 的检查是多余的，因为 m_wholeApiList 的初值为 m_apiList 。

--------------------------------------------------------------------------------

d:\work\dev\dk_upgrade_dev\framework\src\BaseTest.cpp:2344

            if (halVerificationDataList[iData].m_bufferData.empty() && (halVerificationDataList[iData].m_format == GfxFormat::UNDEFINED || halVerificationDataList[iData].m_pixelData.size() == 0))
            {
                m_pHalTests[index]->SetVerificationStatus(m_halTestApiOrdinals[index], statusInfo);
            }

该 if 语句中的 SetVerificationStatus 的调用是不必要的，因为在循环结束之后，又调用了一次。

--------------------------------------------------------------------------------



调用顺序：

OnStartTestCase
    RegisterFramebuffer
        RegisterImageView

1. `RegisterImageView` 注册 `VerificationView` 时，将其存入 `m_verificationInfo` 变量。因此，也需要添加一个类似的成员变量，存放图像比较的内容。
2.

GllBaseTest::m_verificationInfo;

在基类 BaseTest 中设置了注册的 ImageView 的数量，暂时不知道有什么用处理。
BaseTest::m_registeredImageViewCount;
BaseTest::SetRegisteredImageViewCount(count);
BaseTest::GetRegisteredImageViewCount();

仅设置验证的结果，真正的验证步骤在 TestProxy::OnVerifyResult() 函数中。
BaseTest::SetVerificationStatus
TestResult::SetVerificationStatus

猜测调用关系如下：
TestProxy::OnVerifyResult()
    TestProxy::VerifyPixelData()
        PixelFormatter::CheckPixel()
    TestProxy::VerifyBufferData()

在 TestContext::RunTestCase 调用 TestProxy::OnVerifyResult 。

相关变量：

m_pHalTests
m_pRefTests

猜测：当前验证模式为 MULTI_PASS ，因此 m_pHalTests 和 m_pRefTests 的大小为 1 。如果是 SINGLE_PASS ，它们的大小应该是比较的的 API 的个数。

m_pHalTestApiOrdinals
m_pRefTestApiOrdinals

VerificationStatus
{
    NA,
    FAIL,
    PASS,
    AUTO,
}

VerificationStatusInfo
{
    uint32_t halTestOrdinal;
    uint32_t refTestOrdinal;
    VerificationStatus status;
}

        statusInfo.status = m_pTestHelper->GetTestCaseVerificationStatus(m_testCaseId, reason);

函数 GetTestCaseVerificationStatus 仅在 TexDimensiion 和 TexFetch 中被改写。全图比较时，也需要禁用掉。

BaseTest::GetCurrentFrameIndex() 返回当前帧的索引号。

TestProxy::SetApiOrdinal(apiOrdinal)
    TestHelper::SetCurrentApiOrdinal(apiOrdinal)
        m_currApi = apiOrdinal;

TestProxy::SetApiOrdinal 看起来和 BaseTest::OnGetVerificationData 有关系。因为在后者之前设置，在后者调用完成后恢复。
??? 没看到有啥关系。

struct VerificationData
{
    GfxFormat m_format;
    std::vector<uint8_t> m_pixelData;
    std::vector<uint8_t> m_bufferData;
};

typedef std::vector<VerificationData> VerificationDataList;

BaseTest::OnGetVerificationData() 得到要验证的区域的 format 和 pixel 的数据及 buffer 数据。
通过 GllBaseTest::m_verificationInfo 获取以上数据。

明天研读该函数：
TestProxy::VerifyPixelData

TestProxy::OnStartTestCase(testCase) 设置 m_randomFrameIndexForVerification 为随机值：
    m_randomFrameIndexForVerification = Math::rand() % m_pTestHelper->GetTestFrames()

TestProxy::OnRunTestCase(testCase) 如果没有注册的 Verification View ，并且不需要 Present 或者 Dump ，则不运行 REF_TEST_OPERATION 。

德国威能服务热线 4007001890

构造参考 API 列表的函数。如果参考 API 列表中，只有 1 个元素，那么调整参考 API 列表大小与 API 列表大小相同，并复制该唯一元素到参考 API 中的所有元素。


void TestHelper::ConstructRefApiList()


疑问：

当 VerificationMode 启用时，并且 DumpImage 也启用时，如何 Dump 多个 API 的图片？

Sch

TestContext 包含如下 Test 上下文相关的成员变量：

相关的对象：

    BenchApp       m_pApp
    TestContainer* m_pTestContainer
    TestHelper*    m_pTestHelper
    TestProxy*     m_pTestProxy
    TestResult*    m_pTestResult
    TestStatistic* m_pTestStatistic
    MessageLog*    m_pLog

当前的状态：

    m_currApiOrdinal
    m_curApi
    m_curTestCaseId
    m_curFrameIdx

Test 、 TestCase 及 Api 相关状态：

    PerTestFlags     m_perTestFlags
    PerApiFlags      m_perApiFlags
    PerTestCaseFlags m_perTestCaseFlags

计时器、设置状态：

    Timers m_timers
    Settings m_settings

杂项：

    std::list m_crashTestCases


